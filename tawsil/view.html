<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>عرض الطلبات</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* جميع أنماط الCSS السابقة */
    .back-btn-top {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        display: flex;
        gap: 10px;
    }

    .back-btn-top button {
        background-color: #8e24aa;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-family: Tahoma;
        font-size: 16px;
        transition: background-color 0.3s;
    }

    .back-btn-top button:hover {
        background-color: #6a1b9a;
    }

    h1 {
        margin-top: 50px;
        padding: 0 15px;
    }

    @media print {
      .no-print, #clientSelect, .back-btn-top, .buttons, #editModal, .toast, .back-btn-bottom {
        display: none !important;
      }
      
      table {
        width: 100% !important;
        margin-top: 20px;
        box-shadow: none;
      }
      
      th, td {
        padding: 8px;
        font-size: 14px;
        background-color: white !important;
      }
      
      .summary {
        box-shadow: none;
        margin: 20px 0;
      }
    }

    body {
      font-family: Tahoma, sans-serif;
      background-color: #f3e5f5;
      margin: 0;
      padding: 20px;
      color: #333;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background-color: #f8f0fc;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    }

    th {
      background-color: #ce93d8 !important;
      color: #4a148c;
    }

    tr:nth-child(even) {
      background-color: #f3e5f5;
    }

    .summary {
      margin-top: 30px;
      background-color: #e1bee7;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-size: 18px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      justify-items: center;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 120px;
      height: 80px;
    }

    .summary-item .title {
      background-color: #6a1b9a;
      color: white;
      padding: 8px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      border-radius: 8px 8px 0 0;
    }

    .summary-item .value {
      background-color: #d1c4e9;
      color: #4a148c;
      padding: 8px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      border-radius: 0 0 8px 8px;
    }

    .currency-icon {
      width: 18px;
      height: 18px;
      vertical-align: middle;
      margin-right: 3px;
    }

    .buttons {
      margin-top: 20px;
      text-align: center;
    }

    button {
      background-color: #8e24aa;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      min-width: 80px;
      touch-action: manipulation;
    }

    button:hover {
      background-color: #6a1b9a;
    }

    .delete-btn {
      background-color: #ff5722;
    }

    .delete-btn:hover {
      background-color: #e64a19;
    }

    .pdf-btn {
      background-color: #0288d1;
    }

    .pdf-btn:hover {
      background-color: #0277bd;
    }

    .refresh-btn {
      background-color: #4CAF50;
    }

    .refresh-btn:hover {
      background-color: #45a049;
    }

    .edit-icon {
      font-size: 22px;
      color: #0288d1;
      cursor: pointer;
    }

    .trash-icon {
      cursor: pointer;
      display: inline-block;
      padding: 5px;
    }

    .trash-icon img {
      width: 28px;
      height: 28px;
      vertical-align: middle;
    }

    .delete-client-icon img {
      filter: hue-rotate(90deg) saturate(150%) brightness(1);
    }

    .invoice-preview {
      color: #6a1b9a;
      cursor: pointer;
      text-decoration: underline;
    }

    select {
      font-size: 16px;
      padding: 8px;
      width: 200px;
      border-radius: 8px;
      max-width: 300px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #f3e5f5;
      border: 2px solid #6a1b9a;
      margin: 10% auto;
      padding: 20px;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .close {
      color: #aaa;
      float: left;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: black;
    }

    .modal-title {
      text-align: center;
      color: #6a1b9a;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }

    .modal-footer {
      text-align: center;
      margin-top: 20px;
    }

    .save-btn {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    .save-btn:hover {
      background-color: #45a049;
    }

    .toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #4CAF50;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 16px;
      position: fixed;
      z-index: 1001;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 17px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .toast.show {
      visibility: visible;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    .custom-confirm-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #f3e5f5;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      z-index: 1000;
      text-align: center;
      max-width: 400px;
      border: 2px solid #6a1b9a;
    }

    .custom-confirm-modal p {
      color: #4a148c;
      font-size: 18px;
      margin-bottom: 20px;
    }

    .custom-confirm-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    .custom-confirm-button {
      padding: 10px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }

    .confirm-ok {
      background-color: #d32f2f;
      color: white;
    }

    .confirm-ok:hover {
      background-color: #b71c1c;
    }

    .confirm-cancel {
      background-color: #6a1b9a;
      color: white;
    }

    .confirm-cancel:hover {
      background-color: #4a148c;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 999;
    }

    #invoiceViewer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        display: none;
    }

    #invoiceCloseBtn {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        font-size: 35px;
        cursor: pointer;
        z-index: 10000;
        padding: 5px 15px;
    }

    #invoiceContainer {
        position: relative;
        width: 95%;
        height: 85%;
        margin: 5% auto;
    }

    @keyframes fadein {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    @keyframes fadeout {
      from {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      to {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
        font-size: 14px;
      }

      table {
        font-size: 12px;
        margin-top: 15px;
      }

      th, td {
        padding: 8px 4px;
      }

      button {
        padding: 12px 15px;
        font-size: 14px;
        margin: 3px;
      }

      .summary {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 10px;
        font-size: 16px;
      }

      .summary-item {
        width: 100%;
        height: auto;
      }

      .modal-content {
        width: 90% !important;
        margin: 20% auto !important;
        padding: 15px !important;
      }

      select {
        width: 100% !important;
        font-size: 14px !important;
        padding: 10px !important;
      }
    }

    /* التعديلات الجديدة */
    td:nth-child(8) {
        max-width: 250px !important;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        position: relative;
        padding-right: 100px !important;
        text-align: right !important;
    }

    .read-more {
        position: absolute;
        left: 5px;
        bottom: 2px;
        color: #1a73e8 !important;
        cursor: pointer;
        font-size: 12px;
        padding: 2px 5px;
        text-decoration: underline;
        background: transparent !important;
        border: none !important;
    }

    .read-more:hover {
        color: #0d47a1 !important;
        text-decoration: none;
    }

    .full-text {
        white-space: normal !important;
        word-break: break-word;
        text-align: right;
        display: block;
        padding-bottom: 20px;
    }

    @media print {
        td:nth-child(8) {
            white-space: normal !important;
            text-overflow: clip !important;
            max-width: none !important;
            padding-right: 12px !important;
        }
        
        .read-more {
            display: none !important;
        }
    }
  </style>
</head>
<body>
  <div class="back-btn-top no-print">
    <button onclick="window.location.href='index.html'">➔ السابقة</button>
    <button onclick="window.location.href='../index.html'">الرئيسية</button>
  </div>

  <h1>عرض الطلبات</h1>
  
  <label for="clientSelect" class="no-print">اختيار عميل:</label>
  <select id="clientSelect" class="no-print" onchange="filterOrdersByClient()">
    <option value="all" selected>الكل</option>
  </select>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>العميل</th>
        <th>الوصف</th>
        <th>سعر الطلب</th>
        <th>سعر التوصيل</th>
        <th>المبلغ المدفوع</th>
        <th>تاريخ الطلب</th>
        <th>ملاحظات</th>
        <th>الفاتورة</th>
        <th class="no-print">تعديل</th>
        <th class="no-print">حذف الطلب</th>
        <th class="no-print">حذف العميل</th>
      </tr>
    </thead>
    <tbody id="ordersTable"></tbody>
  </table>

  <div class="summary">
    <div class="summary-item">
      <div class="title">عدد الطلبات:</div>
      <div class="value" id="totalRequests">0</div>
    </div>
    <div class="summary-item">
      <div class="title">تكاليف الطلبات:</div>
      <div class="value" id="totalOrderPrice">0.00 <img src="icons/real.png" alt="ريال" class="currency-icon"></div>
    </div>
    <div class="summary-item">
      <div class="title">إجمالي المدفوع:</div>
      <div class="value" id="totalPaid">0.00 <img src="icons/real.png" alt="ريال" class="currency-icon"></div>
    </div>
    <div class="summary-item">
      <div class="title">المجموع الكلي:</div>
      <div class="value" id="remainingAmount">0.00 <img src="icons/real.png" alt="ريال" class="currency-icon"></div>
    </div>
  </div>

  <div class="buttons no-print">
    <button class="refresh-btn" onclick="window.location.reload()">تحديث</button>
    <button class="pdf-btn" onclick="exportToPDF()">PDF</button>
    <button class="delete-btn" onclick="deleteAllOrders()">حذف الكل</button>
    <button onclick="window.print()">طباعة</button>
  </div>

  <!-- Modal التعديل -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 class="modal-title">تعديل الطلب</h2>
      <form id="editForm">
        <input type="hidden" id="editOrderId">
        <div class="form-group">
          <label for="editClient">العميل:</label>
          <input type="text" id="editClient" required>
        </div>
        <div class="form-group">
          <label for="editDescription">الوصف:</label>
          <input type="text" id="editDescription" required>
        </div>
        <div class="form-group">
          <label for="editOrderPrice">سعر الطلب:</label>
          <input type="number" id="editOrderPrice" step="0.01" required>
        </div>
        <div class="form-group">
          <label for="editDeliveryPrice">سعر التوصيل:</label>
          <input type="number" id="editDeliveryPrice" step="0.01" required>
        </div>
        <div class="form-group">
          <label for="editPaidAmount">المبلغ المدفوع:</label>
          <input type="number" id="editPaidAmount" step="0.01" required>
        </div>
        <div class="form-group">
          <label for="editOrderDate">تاريخ الطلب:</label>
          <input type="date" id="editOrderDate" required>
        </div>
        <div class="form-group">
          <label for="editNotes">ملاحظات:</label>
          <textarea id="editNotes" rows="3"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="save-btn" onclick="saveEditedOrder()">حفظ التعديلات</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast الإشعار -->
  <div id="toast" class="toast">تم التعديل بنجاح</div>

  <!-- نافذة التأكيد المخصصة -->
  <div class="modal-overlay" id="confirmOverlay"></div>
  <div class="custom-confirm-modal" id="customConfirm">
    <p id="confirmMessage"></p>
    <div class="custom-confirm-buttons">
      <button class="custom-confirm-button confirm-cancel" onclick="hideConfirm()">إلغاء</button>
      <button class="custom-confirm-button confirm-ok" onclick="handleConfirm()">موافق</button>
    </div>
  </div>

  <!-- عنصر عرض الفاتورة -->
  <div id="invoiceViewer">
    <div id="invoiceCloseBtn">&times;</div>
    <div id="invoiceContainer"></div>
  </div>

  <script>
    // تهيئة البيانات
    let orders = JSON.parse(localStorage.getItem("orders")) || [];
    let clients = JSON.parse(localStorage.getItem("clients")) || [];
    
    // تأكد من أن البيانات مصفوفات
    if (!Array.isArray(orders)) orders = [];
    if (!Array.isArray(clients)) clients = [];

    // عناصر DOM
    const tableBody = document.getElementById("ordersTable");
    const clientSelect = document.getElementById("clientSelect");
    
    // التهيئة الأولية
    function initializeData() {
      if (orders.length === 0) {
        orders = [
          {
            id: 1,
            client: "عميل تجريبي",
            description: "طلب تجريبي 1",
            orderPrice: 150.00,
            deliveryPrice: 25.00,
            paidAmount: 75.00,
            orderDate: "2023-10-01",
            notes: "ملاحظات تجريبية"
          },
          {
            id: 2,
            client: "عميل تجريبي",
            description: "طلب تجريبي 2",
            orderPrice: 200.00,
            deliveryPrice: 30.00,
            paidAmount: 100.00,
            orderDate: "2023-10-02",
            notes: "ملاحظات تجريبية"
          }
        ];
        localStorage.setItem("orders", JSON.stringify(orders));
        localStorage.setItem("clients", JSON.stringify(["عميل تجريبي"]));
      }
    }
    initializeData();

    // دوال العرض
    function loadOrders(filteredOrders = orders) {
      tableBody.innerHTML = "";
      filteredOrders.forEach((order, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${order.client}</td>
          <td>${order.description}</td>
          <td>${order.orderPrice.toFixed(2)}</td>
          <td>${order.deliveryPrice.toFixed(2)}</td>
          <td>${order.paidAmount.toFixed(2)}</td>
          <td>${order.orderDate}</td>
          <td data-full-text="${order.notes || ''}">${order.notes || ""}</td>
          <td>
            ${order.invoice ? 
              `<span class="invoice-preview" onclick="showInvoice('${order.invoice}')">عرض</span>` : 
              'لا يوجد'}
          </td>
          <td class="no-print"><span class="edit-icon" onclick="editOrder(${order.id})">&#9998;</span></td>
          <td class="no-print">
            <span class="trash-icon" onclick="confirmDeleteOrder(${order.id})">
              <img src="icons/trash-icon.png" alt="حذف طلب">
            </span>
          </td>
          <td class="no-print">
            <span class="trash-icon delete-client-icon" onclick="deleteClient('${order.client}')">
              <img src="icons/trash-icon.png" alt="حذف عميل">
            </span>
          </td>
        `;
        tableBody.appendChild(row);
      });
      processNotesCells();
      updateSummary(filteredOrders);
    }

    function updateSummary(filteredOrders) {
      let totalRequests = filteredOrders.length;
      let totalOrderPrice = filteredOrders.reduce((sum, order) => sum + order.orderPrice, 0);
      let totalDeliveryPrice = filteredOrders.reduce((sum, order) => sum + order.deliveryPrice, 0);
      let totalPaid = filteredOrders.reduce((sum, order) => sum + order.paidAmount, 0);
      
      const remainingBalance = (totalOrderPrice + totalDeliveryPrice) - totalPaid;
      let balanceStatus = remainingBalance > 0 ? "(باقي على العميل)" : 
                         remainingBalance < 0 ? "(زيادة دفع)" : "(تم التسوية)";

      document.getElementById("totalRequests").textContent = totalRequests;
      document.getElementById("totalOrderPrice").innerHTML = totalOrderPrice.toFixed(2) + ' <img src="icons/real.png" alt="ريال" class="currency-icon">';
      document.getElementById("totalPaid").innerHTML = totalPaid.toFixed(2) + ' <img src="icons/real.png" alt="ريال" class="currency-icon">';
      document.getElementById("remainingAmount").innerHTML = 
        Math.abs(remainingBalance).toFixed(2) + ' <img src="icons/real.png" alt="ريال" class="currency-icon"> ' + balanceStatus;
    }

    // بقية الدوال
    function filterOrdersByClient() {
      const selectedClient = clientSelect.value;
      const filtered = selectedClient === "all" ? 
        orders : 
        orders.filter(order => order.client === selectedClient);
      loadOrders(filtered);
    }

    // ... (بقية الدوال كما هي من الإصدار السابق)

    // التحميل الأولي عند فتح الصفحة
    window.addEventListener('DOMContentLoaded', () => {
      loadOrders(orders);
      clientSelect.value = 'all';
    });
  </script>
</body>
</html>
