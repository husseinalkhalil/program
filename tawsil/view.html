<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>عرض الطلبات</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* جميع أنماط ال CSS السابقة بدون أي تغيير */
    /* ... (الأنماط الأصلية كما هي) ... */
  </style>
</head>
<body>
  <!-- جميع عناصر ال HTML السابقة بدون أي تغيير -->
  <div class="back-btn-top no-print">
    <button onclick="window.location.href='index.html'">➔ السابقة</button>
    <button onclick="window.location.href='../index.html'">الرئيسية</button>
  </div>

  <h1>عرض الطلبات</h1>
  
  <label for="clientSelect" class="no-print">اختيار عميل:</label>
  <select id="clientSelect" class="no-print" onchange="filterOrdersByClient()">
    <option value="all" selected>الكل</option>
  </select>

  <table>
    <!-- الجدول كما هو -->
    <!-- ... (العناصر الأصلية كما هي) ... -->
  </table>

  <div class="summary">
    <!-- عناصر الإحصائيات كما هي -->
    <!-- ... (العناصر الأصلية كما هي) ... -->
  </div>

  <div class="buttons no-print">
    <!-- الأزرار كما هي -->
    <!-- ... (العناصر الأصلية كما هي) ... -->
  </div>

  <!-- جميع ال modals كما هي -->
  <!-- ... (العناصر الأصلية كما هي) ... -->

  <script>
    let orders = JSON.parse(localStorage.getItem("orders") || "[]");
    const tableBody = document.getElementById("ordersTable");
    const clientSelect = document.getElementById("clientSelect");
    const totalRequestsElem = document.getElementById("totalRequests");
    const totalOrderPriceElem = document.getElementById("totalOrderPrice");
    const totalPaidElem = document.getElementById("totalPaid");
    const remainingAmountElem = document.getElementById("remainingAmount");
    const modal = document.getElementById("editModal");
    const toast = document.getElementById("toast");
    let clients = JSON.parse(localStorage.getItem("clients") || []);

    // التهيئة الأولية للبيانات التجريبية
    if (orders.length === 0) {
      orders = [
        {
          id: 1,
          client: "عميل تجريبي",
          description: "طلب تجريبي 1",
          orderPrice: 150.00,
          deliveryPrice: 25.00,
          paidAmount: 75.00,
          orderDate: "2023-10-01",
          notes: "ملاحظات تجريبية"
        },
        {
          id: 2,
          client: "عميل تجريبي",
          description: "طلب تجريبي 2",
          orderPrice: 200.00,
          deliveryPrice: 30.00,
          paidAmount: 100.00,
          orderDate: "2023-10-02",
          notes: "ملاحظات تجريبية"
        }
      ];
      localStorage.setItem("orders", JSON.stringify(orders));
      localStorage.setItem("clients", JSON.stringify(["عميل تجريبي"]));
    }

    let currentConfirmAction = null;

    // الدوال المساعدة
    function showConfirm(message, callback) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('customConfirm').style.display = 'block';
      document.getElementById('confirmOverlay').style.display = 'block';
      currentConfirmAction = callback;
    }

    function hideConfirm() {
      document.getElementById('customConfirm').style.display = 'none';
      document.getElementById('confirmOverlay').style.display = 'none';
      currentConfirmAction = null;
    }

    function handleConfirm() {
      if (currentConfirmAction) currentConfirmAction();
      hideConfirm();
    }

    // الدالة الرئيسية لتحميل الطلبات
    function loadOrders(filteredOrders = orders) {
      tableBody.innerHTML = "";
      orders = JSON.parse(localStorage.getItem("orders") || "[]");
      clients = JSON.parse(localStorage.getItem("clients") || []);
      
      // تحديث قائمة العملاء
      const currentClient = clientSelect.value;
      clientSelect.innerHTML = '<option value="all" selected>الكل</option>';
      clients.forEach(client => {
        const option = document.createElement("option");
        option.value = client;
        option.textContent = client;
        clientSelect.appendChild(option);
      });
      clientSelect.value = currentClient === "all" ? "all" : currentClient;

      // عرض الطلبات
      filteredOrders.forEach((order, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${order.client}</td>
          <td>${order.description}</td>
          <td>${order.orderPrice.toFixed(2)}</td>
          <td>${order.deliveryPrice.toFixed(2)}</td>
          <td>${order.paidAmount.toFixed(2)}</td>
          <td>${order.orderDate}</td>
          <td data-full-text="${order.notes || ''}">${order.notes || ""}</td>
          <td>
            ${order.invoice ? 
              `<span class="invoice-preview" onclick="showInvoice('${order.invoice}')">عرض</span>` : 
              'لا يوجد'}
          </td>
          <td class="no-print"><span class="edit-icon" onclick="editOrder(${order.id})">&#9998;</span></td>
          <td class="no-print">
            <span class="trash-icon" onclick="confirmDeleteOrder(${order.id})">
              <img src="icons/trash-icon.png" alt="حذف طلب">
            </span>
          </td>
          <td class="no-print">
            <span class="trash-icon delete-client-icon" onclick="deleteClient('${order.client}')">
              <img src="icons/trash-icon.png" alt="حذف عميل">
            </span>
          </td>
        `;
        tableBody.appendChild(row);
      });

      processNotesCells();
    }

    // دالة تحديث الإحصائيات المعدلة
    function updateSummary(filteredOrders) {
      let totalRequests = 0;
      let totalOrderPrice = 0;
      let totalDeliveryPrice = 0;
      let totalPaid = 0;

      filteredOrders.forEach(order => {
        totalRequests++;
        totalOrderPrice += order.orderPrice;
        totalDeliveryPrice += order.deliveryPrice;
        totalPaid += order.paidAmount;
      });

      const remainingBalance = (totalOrderPrice + totalDeliveryPrice) - totalPaid;
      let balanceStatus = "";
      if (remainingBalance > 0) balanceStatus = "(باقي على العميل)";
      else if (remainingBalance < 0) balanceStatus = "(زيادة دفع)";
      else balanceStatus = "(تم التسوية)";

      totalRequestsElem.textContent = totalRequests;
      totalOrderPriceElem.innerHTML = totalOrderPrice.toFixed(2) + ' <img src="icons/real.png" alt="ريال" class="currency-icon">';
      totalPaidElem.innerHTML = totalPaid.toFixed(2) + ' <img src="icons/real.png" alt="ريال" class="currency-icon">';
      remainingAmountElem.innerHTML = 
        Math.abs(remainingBalance).toFixed(2) + ' <img src="icons/real.png" alt="ريال" class="currency-icon"> ' + balanceStatus;
    }

    // دالة الفلترة المعدلة
    function filterOrdersByClient() {
      const selectedClient = clientSelect.value;
      orders = JSON.parse(localStorage.getItem("orders") || "[]");
      if (selectedClient === "all") {
        loadOrders(orders);
        updateSummary(orders);
      } else {
        const filteredOrders = orders.filter(order => order.client === selectedClient);
        loadOrders(filteredOrders);
        updateSummary(filteredOrders);
      }
    }

    // دوال الحذف المعدلة
    function deleteClient(client) {
      showConfirm(`هل أنت متأكد من حذف العميل ${client}؟`, () => {
        orders = orders.filter(order => order.client !== client);
        localStorage.setItem("orders", JSON.stringify(orders));
        
        clients = clients.filter(c => c !== client);
        localStorage.setItem("clients", JSON.stringify(clients));
        
        localStorage.setItem("clientUpdateTrigger", Date.now().toString());
        
        const filteredOrders = clientSelect.value === 'all' ? orders : [];
        loadOrders(filteredOrders);
        updateSummary(filteredOrders);
      });
    }

    function confirmDeleteOrder(orderId) {
      showConfirm("هل أنت متأكد من حذف هذا الطلب؟", () => {
        orders = orders.filter(order => order.id !== orderId);
        localStorage.setItem("orders", JSON.stringify(orders));
        const filteredOrders = orders.filter(order => 
          clientSelect.value === 'all' || order.client === clientSelect.value
        );
        loadOrders(filteredOrders);
        updateSummary(filteredOrders);
      });
    }

    function deleteAllOrders() {
      showConfirm("هل أنت متأكد من حذف جميع البيانات؟", () => {
        localStorage.setItem("orders", "[]");
        localStorage.setItem("clientUpdateTrigger", Date.now().toString());
        orders = [];
        loadOrders([]);
        updateSummary([]);
      });
    }

    // دوال التعديل المعدلة
    function editOrder(orderId) {
      const order = orders.find(o => o.id === orderId);
      if (order) {
        document.getElementById("editOrderId").value = order.id;
        document.getElementById("editClient").value = order.client;
        document.getElementById("editDescription").value = order.description;
        document.getElementById("editOrderPrice").value = order.orderPrice;
        document.getElementById("editDeliveryPrice").value = order.deliveryPrice;
        document.getElementById("editPaidAmount").value = order.paidAmount;
        document.getElementById("editOrderDate").value = order.orderDate;
        document.getElementById("editNotes").value = order.notes || "";
        modal.style.display = "block";
      }
    }

    function saveEditedOrder() {
      const orderId = parseInt(document.getElementById("editOrderId").value);
      const index = orders.findIndex(o => o.id === orderId);
      
      if (index !== -1) {
        orders[index] = {
          id: orderId,
          client: document.getElementById("editClient").value,
          description: document.getElementById("editDescription").value,
          orderPrice: parseFloat(document.getElementById("editOrderPrice").value),
          deliveryPrice: parseFloat(document.getElementById("editDeliveryPrice").value),
          paidAmount: parseFloat(document.getElementById("editPaidAmount").value),
          orderDate: document.getElementById("editOrderDate").value,
          notes: document.getElementById("editNotes").value
        };
        
        localStorage.setItem("orders", JSON.stringify(orders));
        const filteredOrders = orders.filter(order => 
          clientSelect.value === 'all' || order.client === clientSelect.value
        );
        loadOrders(filteredOrders);
        updateSummary(filteredOrders);
        closeModal();
        showToast();
      }
    }

    // باقي الدوال الثانوية
    function closeModal() { modal.style.display = "none"; }
    function showToast() {
      toast.className = "toast show";
      setTimeout(() => toast.className = toast.className.replace("show", ""), 3000);
    }
    function showInvoice(imageData) { /* ... (كما هي) ... */ }
    function exportToPDF() { /* ... (كما هي) ... */ }
    function processNotesCells() { /* ... (كما هي) ... */ }

    // المتابعة بالحدث عند التحميل
    document.addEventListener('DOMContentLoaded', () => {
      loadOrders();
      updateSummary(orders);
    });
  </script>
</body>
</html>
