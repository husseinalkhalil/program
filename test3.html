<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport"/>
    <title>معاينة كتاب - حسين الخليل</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #5e2ca5;
            --primary-light: #7a52cc;
            --primary-dark: #451b7a;
            --text-dark: #333333;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            touch-action: none;
        }

        /* شاشة التحميل */
        #loading-screen {
            position: fixed; 
            inset: 0; 
            background: var(--bg-white);
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999;
        }
        .loader {
            width: 60px; 
            height: 60px; 
            border: 5px solid var(--bg-light);
            border-top: 5px solid var(--primary-color); 
            border-radius: 50%; 
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 
            to { transform: rotate(360deg); }
        }
        .progress-container { 
            width: 250px; 
            height: 6px; 
            background: var(--bg-light); 
            border-radius: 3px; 
            overflow: hidden; 
        }
        .progress-bar { 
            height: 100%; 
            background: var(--primary-color); 
            width: 0%; 
            transition: width 0.4s ease; 
        }

        /* الهيدر العلوي */
        .header {
            background: var(--bg-white); 
            padding: 0 20px; 
            height: 60px;
            box-shadow: var(--shadow); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            z-index: 100; 
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
        }
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .menu-toggle {
            background: none; 
            border: none; 
            color: var(--primary-color); 
            font-size: 1.4rem;
            cursor: pointer; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        .logo { 
            height: 30px; 
            object-fit: contain; 
        }
        .header-title { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: var(--primary-dark); 
        }
        .close-btn {
            background: var(--primary-color); 
            color: white; 
            padding: 6px 15px;
            border-radius: 20px; 
            text-decoration: none; 
            font-weight: 700; 
            font-size: 0.85rem;
            display: flex; 
            align-items: center; 
            gap: 6px;
        }

        /* القائمة الجانبية */
        .sidebar-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 998; 
            display: none; 
        }
        .sidebar {
            position: fixed; 
            top: 0; 
            right: -320px; 
            width: 300px; 
            height: 100vh;
            background: white; 
            z-index: 999; 
            transition: right 0.3s ease;
            display: flex; 
            flex-direction: column; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar.active { 
            right: 0; 
        }
        .sidebar-header { 
            padding: 20px; 
            background: var(--primary-color); 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .sidebar-content { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
        }
        .page-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            margin-top: 15px; 
        }
        .pg-btn { 
            background: var(--bg-light); 
            border: none; 
            padding: 12px 5px; 
            border-radius: 8px; 
            font-weight: 700; 
            cursor: pointer; 
        }
        .pg-btn.active { 
            background: var(--primary-color); 
            color: white; 
        }

        /* منطقة العرض الرئيسية */
        .viewer-area { 
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 120px;
            background: #1a252f;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            cursor: grab;
        }
        
        .viewer-area.grabbing {
            cursor: grabbing;
        }
        
        .viewer-area.panning {
            cursor: move;
        }
        
        /* منطقة الصور */
        .image-viewer {
            flex: 1; 
            overflow: hidden;
            background: #1a252f;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .image-container { 
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            min-height: 200px;
            position: relative;
            transform-origin: center center;
            transition: transform 0.15s cubic-bezier(0.1, 0.57, 0.1, 1);
            will-change: transform;
        }

        .page-image {
            display: block;
            width: auto;
            height: auto;
            max-width: none;
            max-height: none;
            object-fit: contain;
            border-radius: 4px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            pointer-events: none;
            user-select: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
        }

        /* شريط التحكم السفلي (التنقل والزووم) */
        .controls-bar {
            background: rgba(0, 0, 0, 0.9); 
            padding: 10px 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            backdrop-filter: blur(10px); 
            z-index: 90;
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            height: 60px;
        }
        .nav-controls, .zoom-controls { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .control-btn {
            width: 44px; 
            height: 44px; 
            background: rgba(255,255,255,0.12); 
            border: none;
            border-radius: 50%; 
            color: white; 
            font-size: 1.1rem; 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: var(--transition);
        }
        .control-btn:disabled { 
            opacity: 0.3; 
            cursor: not-allowed; 
        }
        .page-indicator { 
            color: white; 
            font-size: 1rem; 
            font-weight: 600; 
            min-width: 80px; 
            text-align: center; 
        }
        .zoom-display { 
            color: white; 
            font-size: 0.9rem; 
            min-width: 60px; 
            text-align: center; 
            background: rgba(255,255,255,0.1); 
            padding: 5px 10px; 
            border-radius: 20px; 
        }

        /* شريط الإجراءات (زر الشراء بالأسفل) */
        .action-bar {
            background: var(--bg-white); 
            padding: 12px 20px;
            border-top: 1px solid #e9ecef; 
            display: flex; 
            flex-direction: column;
            z-index: 100;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            justify-content: center;
        }
        .action-button {
            background: var(--primary-color); 
            color: white; 
            padding: 12px 20px;
            border-radius: 10px; 
            text-decoration: none; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        /* =========================================== */
        /* تعديلات نسخة الجوال فقط لضبط زر الشراء */
        /* =========================================== */
        @media (max-width: 767px) {
            .controls-bar { 
                padding: 8px 10px; 
                gap: 5px; 
                height: 50px;
            }
            .control-btn { 
                width: 40px; 
                height: 40px; 
                font-size: 0.9rem; 
            }
            .nav-controls, .zoom-controls { gap: 5px; }
            .page-indicator { 
                min-width: 60px; 
                font-size: 0.85rem; 
            }
            .zoom-display { 
                min-width: 50px; 
                padding: 4px 6px; 
                font-size: 0.8rem; 
            }
            
            .viewer-area {
                top: 60px;
                bottom: 120px; /* ترك مساحة كافية للشريط السفلي */
            }
            
            /* تعديل شريط الشراء للجوال */
            .action-bar {
                height: 70px; /* زيادة الارتفاع الكلي للشريط */
                padding: 10px 15px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* تعديل الزر نفسه لمنع قص النص */
            .action-button {
                padding: 0 15px; /* إزالة البادينج الرأسي والاعتماد على الارتفاع */
                height: 48px;    /* إعطاء الزر ارتفاع ثابت ومريح */
                font-size: 0.8rem; /* حجم خط مناسب */
                gap: 8px;
                line-height: 1.8;  /* زيادة المسافة بين السطور لمنع قص الحروف العربية */
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                overflow: visible; /* التأكد من أن النص لا يُحجب */
            }
            
            .image-viewer {
                padding: 0;
            }
            
            .sidebar {
                width: 280px;
            }
        }
        /* =========================================== */

        /* تنسيق الكمبيوتر */
        @media (min-width: 768px) {
            .action-bar { align-items: center; }
            .action-button { width: 100%; max-width: 350px; }
            .image-viewer { padding: 20px; }
            .viewer-area { cursor: grab; }
            .viewer-area:hover { cursor: grab; }
        }

        /* إصلاح مشاكل اللمس على iOS */
        @supports (-webkit-touch-callout: none) {
            .image-viewer { height: -webkit-fill-available; }
            .viewer-area { bottom: calc(130px + env(safe-area-inset-bottom, 0px)); }
            .action-bar {
                padding-bottom: env(safe-area-inset-bottom, 0px);
                height: calc(70px + env(safe-area-inset-bottom, 0px));
            }
        }

        .notif {
            position: fixed; 
            bottom: 140px; 
            left: 50%; 
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8); 
            color: white; 
            padding: 8px 16px;
            border-radius: 20px; 
            z-index: 2000; 
            display: none; 
            font-size: 0.8rem;
        }
        
        .fallback-message {
            display: none;
            color: white;
            text-align: center;
            padding: 20px;
            max-width: 90%;
            margin: 0 auto;
        }
        
        .drag-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 100;
            display: none;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="loader"></div>
    <div class="progress-container"><div class="progress-bar" id="pb"></div></div>
    <div id="loading-text" style="margin-top: 15px; color: var(--primary-color); font-weight: 600;">جاري تحميل الكتاب...</div>
</div>

<div class="app-container" id="app" style="display: none;">
    <div class="sidebar-overlay" id="overlay" onclick="closeSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>فهرس الكتاب</span>
            <i class="fas fa-times" onclick="closeSidebar()" style="cursor: pointer;"></i>
        </div>
        <div class="sidebar-content">
            <div class="page-grid" id="pg-grid"></div>
        </div>
    </div>

    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <img src="images/logo.png" alt="Logo" class="logo">
            <div class="header-title">معاينة الكتاب</div>
        </div>
        <a href="books.html" class="close-btn"><i class="fas fa-times"></i> إغلاق</a>
    </header>
    
    <main class="viewer-area" id="viewer-area">
        <div class="image-viewer" id="viewer">
            <div class="image-container" id="image-container">
                <img id="page-image" class="page-image" src="" alt="صفحة الكتاب">
            </div>
            <div class="fallback-message" id="fallback-msg">
                <h3>لا يمكن تحميل الصفحة</h3>
                <p>إذا استمرت المشكلة، يرجى استخدام نسخة الكمبيوتر</p>
            </div>
            <div class="drag-indicator" id="drag-indicator">اسحب للتحريك</div>
        </div>
    </main>
    
    <div class="controls-bar">
        <div class="nav-controls">
            <button class="control-btn" id="prev" onclick="prevPage()"><i class="fas fa-chevron-right"></i></button>
            <div class="page-indicator" id="p-ind">1 / 0</div>
            <button class="control-btn" id="next" onclick="nextPage()"><i class="fas fa-chevron-left"></i></button>
        </div>
        
        <div class="zoom-controls">
            <button class="control-btn" onclick="zoomOut()"><i class="fas fa-search-minus"></i></button>
            <button class="control-btn" onclick="zoomReset()" title="ملاءمة الشاشة"><i class="fas fa-expand-arrows-alt"></i></button>
            <div class="zoom-display" id="z-dis">100%</div>
            <button class="control-btn" onclick="zoomIn()"><i class="fas fa-search-plus"></i></button>
        </div>
    </div>
    
    <div class="action-bar">
        <a href="#" class="action-button">
            <i class="fas fa-shopping-cart"></i> اشتَرِ الكتاب الكامل الآن
        </a>
    </div>
</div>

<div class="notif" id="notif"></div>

<script>
    // الإبقاء على نفس كود الـ JavaScript الخاص بك دون تغيير لأنه يعمل بشكل صحيح
    const State = {
        pdf: null, totalPages: 0, currentPage: 1, zoom: 1, baseScale: 1.5,
        isMobile: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
        isMac: /Mac/i.test(navigator.platform),
        pagesCache: {}, isLoading: false, renderQuality: 1.0,
        isPanning: false, isDragging: false,
        startPanPoint: { x: 0, y: 0 }, currentPanPoint: { x: 0, y: 0 },
        lastPanPoint: { x: 0, y: 0 }, panVelocity: { x: 0, y: 0 }, panTimestamp: 0,
        panBounds: { minX: 0, maxX: 0, minY: 0, maxY: 0 },
        animationId: null, deceleration: 0.95, minVelocity: 0.1
    };
    
    const D = {
        load: document.getElementById('loading-screen'), app: document.getElementById('app'),
        viewer: document.getElementById('viewer'), viewerArea: document.getElementById('viewer-area'),
        imageContainer: document.getElementById('image-container'), pImg: document.getElementById('page-image'),
        pInd: document.getElementById('p-ind'), zDis: document.getElementById('z-dis'),
        pb: document.getElementById('pb'), sidebar: document.getElementById('sidebar'),
        overlay: document.getElementById('overlay'), pgGrid: document.getElementById('pg-grid'),
        notif: document.getElementById('notif'), fallbackMsg: document.getElementById('fallback-msg'),
        loadingText: document.getElementById('loading-text'), dragIndicator: document.getElementById('drag-indicator')
    };

    async function init() {
        try {
            await loadPDFJS();
            await loadPDFFile();
            D.load.style.display = 'none';
            D.app.style.display = 'block';
            State.baseScale = State.isMobile ? 1.5 : 2.0;
            setupAdvancedPanning();
            setTimeout(() => { zoomReset(); }, 100);
        } catch (error) {
            console.error(error);
            showFallback("فشل تحميل الكتاب.");
        }
    }

    // (باقي دوال السكريبت كما هي في ملفك الأصلي لضمان عمل الكتاب)
    function setupAdvancedPanning() { setupMousePanning(); setupTouchPanning(); setupTrackpadPanning(); preventDefaultBehaviors(); }
    function setupMousePanning() { D.viewer.addEventListener('mousedown', startMousePan); document.addEventListener('mousemove', handleMousePan); document.addEventListener('mouseup', endMousePan); }
    function setupTouchPanning() { D.viewer.addEventListener('touchstart', handleTouchStart, { passive: false }); D.viewer.addEventListener('touchmove', handleTouchMove, { passive: false }); D.viewer.addEventListener('touchend', handleTouchEnd); }
    function setupTrackpadPanning() { D.viewer.addEventListener('wheel', handleWheel, { passive: false }); }
    function preventDefaultBehaviors() { D.viewer.addEventListener('contextmenu', (e) => e.preventDefault()); }
    function startMousePan(e) { if (State.zoom <= 1.0) return; State.isPanning = true; State.startPanPoint = { x: e.clientX - State.currentPanPoint.x, y: e.clientY - State.currentPanPoint.y }; cancelAnimationFrame(State.animationId); }
    function handleMousePan(e) { if (!State.isPanning) return; updatePanPosition(e.clientX - State.startPanPoint.x, e.clientY - State.startPanPoint.y); }
    function endMousePan() { State.isPanning = false; }
    function handleTouchStart(e) { if (e.touches.length !== 1) return; if (State.zoom <= 1.0) { State.touchStart = { x: e.touches[0].clientX, time: Date.now() }; return; } State.isPanning = true; const touch = e.touches[0]; State.startPanPoint = { x: touch.clientX - State.currentPanPoint.x, y: touch.clientY - State.currentPanPoint.y }; cancelAnimationFrame(State.animationId); }
    function handleTouchMove(e) { if (!State.isPanning || e.touches.length !== 1) return; const touch = e.touches[0]; updatePanPosition(touch.clientX - State.startPanPoint.x, touch.clientY - State.startPanPoint.y); e.preventDefault(); }
    function handleTouchEnd(e) { if (State.isPanning) { State.isPanning = false; return; } if (State.touchStart && State.zoom <= 1.0) { const touchEnd = e.changedTouches[0]; const deltaX = State.touchStart.x - touchEnd.clientX; if (Math.abs(deltaX) > 50) { if (deltaX > 0) nextPage(); else prevPage(); } State.touchStart = null; } }
    function handleWheel(e) { if (State.zoom <= 1.0) return; e.preventDefault(); updatePanPosition(State.currentPanPoint.x - e.deltaX, State.currentPanPoint.y - e.deltaY); }
    function updatePanPosition(x, y) { const boundedX = Math.max(State.panBounds.minX, Math.min(State.panBounds.maxX, x)); const boundedY = Math.max(State.panBounds.minY, Math.min(State.panBounds.maxY, y)); State.currentPanPoint = { x: boundedX, y: boundedY }; D.imageContainer.style.transform = `translate(${State.currentPanPoint.x}px, ${State.currentPanPoint.y}px)`; }
    function calculatePanBounds() { if (!D.pImg.complete) return; const containerWidth = D.viewer.clientWidth; const containerHeight = D.viewer.clientHeight; const imgWidth = D.pImg.offsetWidth; const imgHeight = D.pImg.offsetHeight; const extraWidth = Math.max(0, imgWidth - containerWidth); const extraHeight = Math.max(0, imgHeight - containerHeight); State.panBounds = { minX: -extraWidth / 2, maxX: extraWidth / 2, minY: -extraHeight / 2, maxY: extraHeight / 2 }; }
    async function loadPDFJS() { return new Promise((resolve) => { const script = document.createElement('script'); script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js'; script.onload = () => { pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js'; resolve(); }; document.head.appendChild(script); }); }
    async function loadPDFFile() { const pdf = await pdfjsLib.getDocument('pdf/111.pdf').promise; State.pdf = pdf; State.totalPages = Math.min(pdf.numPages, 50); genGrid(); await loadPage(1); }
    async function loadPage(pageNum, force = false) { State.currentPage = pageNum; const page = await State.pdf.getPage(pageNum); const viewport = page.getViewport({ scale: State.baseScale * State.zoom }); const canvas = document.createElement('canvas'); const context = canvas.getContext('2d'); canvas.width = viewport.width; canvas.height = viewport.height; await page.render({ canvasContext: context, viewport: viewport }).promise; renderPage(canvas.toDataURL('image/jpeg', 0.85)); }
    function renderPage(data) { D.pImg.src = data; D.pInd.textContent = `${State.currentPage} / ${State.totalPages}`; updateGrid(); D.pImg.onload = () => { updateImageDisplay(); calculatePanBounds(); }; }
    function updateImageDisplay() { const viewerWidth = D.viewer.clientWidth; const viewerHeight = D.viewer.clientHeight; const baseScale = Math.min(viewerWidth / D.pImg.naturalWidth, viewerHeight / D.pImg.naturalHeight); D.pImg.style.width = (D.pImg.naturalWidth * baseScale * State.zoom) + 'px'; D.pImg.style.height = (D.pImg.naturalHeight * baseScale * State.zoom) + 'px'; }
    function zoomIn() { State.zoom = Math.min(State.zoom + 0.25, 3); updateImageDisplay(); calculatePanBounds(); D.zDis.textContent = Math.round(State.zoom * 100) + "%"; }
    function zoomOut() { State.zoom = Math.max(State.zoom - 0.25, 0.5); updateImageDisplay(); calculatePanBounds(); D.zDis.textContent = Math.round(State.zoom * 100) + "%"; }
    function zoomReset() { State.zoom = 1; loadPage(State.currentPage); D.zDis.textContent = "ملاءمة"; }
    function nextPage() { if (State.currentPage < State.totalPages) loadPage(State.currentPage + 1); }
    function prevPage() { if (State.currentPage > 1) loadPage(State.currentPage - 1); }
    function toggleSidebar() { D.sidebar.classList.add('active'); D.overlay.style.display = 'block'; }
    function closeSidebar() { D.sidebar.classList.remove('active'); D.overlay.style.display = 'none'; }
    function genGrid() { for (let i = 1; i <= State.totalPages; i++) { const btn = document.createElement('button'); btn.className = 'pg-btn'; btn.textContent = i; btn.onclick = () => { loadPage(i); closeSidebar(); }; D.pgGrid.appendChild(btn); } }
    function updateGrid() { const buttons = D.pgGrid.querySelectorAll('.pg-btn'); buttons.forEach((btn, index) => { btn.classList.toggle('active', (index + 1) === State.currentPage); }); }

    document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
